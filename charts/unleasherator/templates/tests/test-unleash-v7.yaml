---
# PostgreSQL database for the Unleash v7 test
apiVersion: v1
kind: Secret
metadata:
  name: postgres-v7-test
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
type: Opaque
data:
  postgres-password: cG9zdGdyZXNwYXNzd29yZA== # postgrespassword
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: postgres-v7-test
  labels:
    app.kubernetes.io/name: postgresql-v7-test
    app.kubernetes.io/part-of: unleasherator
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: postgresql-v7-test
  template:
    metadata:
      labels:
        app.kubernetes.io/name: postgresql-v7-test
    spec:
      containers:
      - name: postgresql
        image: postgres:15.3
        ports:
        - containerPort: 5432
        env:
        - name: POSTGRES_USER
          value: postgres
        - name: POSTGRES_DB
          value: postgres
        - name: POSTGRES_PASSWORD
          valueFrom:
            secretKeyRef:
              name: postgres-v7-test
              key: postgres-password
        volumeMounts:
        - name: postgres-data
          mountPath: /var/lib/postgresql/data
      volumes:
      - name: postgres-data
        emptyDir: {}
---
apiVersion: v1
kind: Service
metadata:
  name: postgres-v7-test
  labels:
    app.kubernetes.io/name: postgresql-v7-test
    app.kubernetes.io/part-of: unleasherator
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
spec:
  ports:
  - port: 5432
    targetPort: 5432
  selector:
    app.kubernetes.io/name: postgresql-v7-test
---
# Direct Unleash v7 instance (not using ReleaseChannel)
apiVersion: unleash.nais.io/v1
kind: Unleash
metadata:
  name: unleash-v7-direct
  labels:
    app.kubernetes.io/name: unleash-v7-direct
    app.kubernetes.io/part-of: unleasherator
    test-type: "direct-v7"
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
spec:
  size: 1
  customImage: "unleashorg/unleash-server:7"
  database:
    secretName: postgres-v7-test
    secretPassKey: postgres-password
    host: postgres-v7-test
    databaseName: postgres
    port: "5432"
    user: postgres
    ssl: "false"
  extraEnvVars:
    - name: ENABLE_OAS
      value: "true"
    - name: LOG_LEVEL
      value: "debug"
  networkPolicy:
    enabled: true
    allowDNS: true
    extraEgressRules:
      - to:
          - podSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql-v7-test
        ports:
          - protocol: TCP
            port: 5432
---
# ReleaseChannel with Unleash v7 for comparison
apiVersion: unleash.nais.io/v1
kind: ReleaseChannel
metadata:
  name: release-channel-v7-test
  labels:
    app.kubernetes.io/name: release-channel-v7-test
    app.kubernetes.io/part-of: unleasherator
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
spec:
  image: "unleashorg/unleash-server:7"
  strategy:
    maxParallel: 1
    batchInterval: "30s"
    maxUpgradeTime: "10m"
  healthChecks:
    enabled: true
    initialDelay: "15s"
    timeout: "3m"
  rollback:
    enabled: false
    onFailure: true
---
# Unleash instance managed by ReleaseChannel v7
apiVersion: unleash.nais.io/v1
kind: Unleash
metadata:
  name: unleash-v7-channel
  labels:
    app.kubernetes.io/name: unleash-v7-channel
    app.kubernetes.io/part-of: unleasherator
    test-type: "channel-v7"
  annotations:
    "helm.sh/hook": test
    #"helm.sh/hook-delete-policy": hook-succeeded
spec:
  size: 1
  database:
    secretName: postgres-v7-test
    secretPassKey: postgres-password
    host: postgres-v7-test
    databaseName: postgres
    port: "5432"
    user: postgres
    ssl: "false"
  releaseChannel:
    name: release-channel-v7-test
  extraEnvVars:
    - name: ENABLE_OAS
      value: "true"
    - name: LOG_LEVEL
      value: "debug"
  networkPolicy:
    enabled: true
    allowDNS: true
    extraEgressRules:
      - to:
          - podSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql-v7-test
        ports:
          - protocol: TCP
            port: 5432
---
# API Token for the direct v7 instance
# apiVersion: unleash.nais.io/v1
# kind: ApiToken
# metadata:
#   name: unleash-v7-direct-token
#   labels:
#     app.kubernetes.io/name: unleash-v7-direct
#     app.kubernetes.io/part-of: unleasherator
#   annotations:
#     "helm.sh/hook": test
#     #"helm.sh/hook-delete-policy": hook-succeeded
# spec:
#   unleashInstance:
#     apiVersion: unleash.nais.io/v1
#     kind: Unleash
#     name: unleash-v7-direct
#   secretName: unleash-v7-direct-token
#   type: CLIENT
#   environment: development
#   projects:
#     - default
# ---
# # API Token for the channel-managed v7 instance
# apiVersion: unleash.nais.io/v1
# kind: ApiToken
# metadata:
#   name: unleash-v7-channel-token
#   labels:
#     app.kubernetes.io/name: unleash-v7-channel
#     app.kubernetes.io/part-of: unleasherator
#   annotations:
#     "helm.sh/hook": test
#     #"helm.sh/hook-delete-policy": hook-succeeded
# spec:
#   unleashInstance:
#     apiVersion: unleash.nais.io/v1
#     kind: Unleash
#     name: unleash-v7-channel
#   secretName: unleash-v7-channel-token
#   type: CLIENT
#   environment: development
#   projects:
#     - default
---
# Test job to verify Unleash v7 functionality
apiVersion: batch/v1
kind: Job
metadata:
  name: unleash-v7-test-probe
  labels:
    app.kubernetes.io/name: unleash-v7-test
    app.kubernetes.io/part-of: unleasherator
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  backoffLimit: 1
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app.kubernetes.io/name: unleash-v7-test
        app.kubernetes.io/part-of: unleasherator
    spec:
      serviceAccountName: {{ include "unleasherator.fullname" . }}-controller-manager
      containers:
      - name: unleash-v7-test
        image: bitnami/kubectl:latest
        command:
        - sh
        - -c
        - |
          set -e
          echo "=== Unleash v7 E2E Test ==="

          # Wait for PostgreSQL to be ready
          echo "1. Waiting for PostgreSQL to be ready..."
          for i in $(seq 1 30); do
            PG_READY=$(kubectl get deployment postgres-v7-test -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
            if [ "$PG_READY" = "1" ]; then
              echo "✓ PostgreSQL is ready"
              break
            fi
            if [ $i -eq 30 ]; then
              echo "✗ PostgreSQL did not become ready"
              exit 1
            fi
            echo "  Attempt $i/30: PostgreSQL not ready yet..."
            sleep 5
          done

          # Wait for ReleaseChannel to be created
          echo ""
          echo "2. Waiting for ReleaseChannel to be created..."
          for i in $(seq 1 20); do
            if kubectl get releasechannel release-channel-v7-test -o jsonpath='{.metadata.name}' 2>/dev/null; then
              echo "✓ ReleaseChannel 'release-channel-v7-test' found"
              break
            fi
            if [ $i -eq 20 ]; then
              echo "✗ ReleaseChannel not found"
              exit 1
            fi
            echo "  Attempt $i/20: Waiting for ReleaseChannel..."
            sleep 3
          done

          # Wait for Unleash deployments to be available
          echo ""
          echo "3. Waiting for Unleash v7 deployments..."
          for instance in unleash-v7-direct unleash-v7-channel; do
            echo "  Checking $instance..."
            for i in $(seq 1 60); do
              DEPLOYMENT_EXISTS=$(kubectl get deployment $instance -o name 2>/dev/null || echo "")
              if [ -n "$DEPLOYMENT_EXISTS" ]; then
                READY=$(kubectl get deployment $instance -o jsonpath='{.status.conditions[?(@.type=="Available")].status}' 2>/dev/null || echo "False")
                REPLICAS=$(kubectl get deployment $instance -o jsonpath='{.status.readyReplicas}' 2>/dev/null || echo "0")
                if [ "$READY" = "True" ] && [ "$REPLICAS" != "0" ]; then
                  echo "  ✓ $instance is Available"
                  break
                fi
              fi
              if [ $i -eq 60 ]; then
                echo "  ✗ $instance did not become ready"
                kubectl describe deployment $instance 2>/dev/null || true
                exit 1
              fi
              if [ $((i % 10)) -eq 0 ]; then
                echo "    Attempt $i/60: waiting..."
              fi
              sleep 5
            done
          done

          # Verify direct v7 instance uses customImage
          echo ""
          echo "4. Verifying direct Unleash v7 instance..."
          DIRECT_IMAGE=$(kubectl get deployment unleash-v7-direct -o jsonpath='{.spec.template.spec.containers[0].image}' 2>/dev/null || echo "")
          if echo "$DIRECT_IMAGE" | grep -q "unleashorg/unleash-server:7"; then
            echo "✓ Direct instance uses correct image: $DIRECT_IMAGE"
          else
            echo "✗ Direct instance has wrong image: $DIRECT_IMAGE"
            exit 1
          fi

          # Verify channel-managed v7 instance uses ReleaseChannel image
          echo ""
          echo "5. Verifying ReleaseChannel-managed Unleash v7 instance..."
          CHANNEL_IMAGE=$(kubectl get unleash unleash-v7-channel -o jsonpath='{.status.resolvedReleaseChannelImage}' 2>/dev/null || echo "")
          RC_NAME=$(kubectl get unleash unleash-v7-channel -o jsonpath='{.status.releaseChannelName}' 2>/dev/null || echo "")

          if [ "$RC_NAME" = "release-channel-v7-test" ]; then
            echo "✓ Instance linked to ReleaseChannel: $RC_NAME"
          else
            echo "✗ Instance not linked to ReleaseChannel correctly: $RC_NAME"
            exit 1
          fi

          if echo "$CHANNEL_IMAGE" | grep -q "unleashorg/unleash-server:7"; then
            echo "✓ Channel instance resolved image: $CHANNEL_IMAGE"
          else
            echo "✗ Channel instance has wrong resolved image: $CHANNEL_IMAGE"
            exit 1
          fi

          echo ""
          echo "=== Unleash v7 E2E Test Completed Successfully ==="
      restartPolicy: Never
