---
apiVersion: unleash.nais.io/v1
kind: Unleash
metadata:
  name: unleash-connection-test
  namespace: default
  labels:
    app.kubernetes.io/name: unleash-connection-test
    app.kubernetes.io/part-of: unleasherator
spec:
  size: 1
  customImage: unleashorg/unleash-server:5
  database:
    secretName: postgres-postgresql
    secretPassKey: postgres-password
    host: postgres-postgresql
    databaseName: postgres
    port: "5432"
    user: postgres
    ssl: "false"
  extraEnvVars:
    - name: ENABLE_OAS
      value: "true"
  networkPolicy:
    enabled: true
    allowDNS: true
    extraEgressRules:
      - to:
          - podSelector:
              matchLabels:
                app.kubernetes.io/name: postgresql
        ports:
          - protocol: TCP
            port: 5432
---
apiVersion: v1
kind: Pod
metadata:
  name: unleash-connection-test
  namespace: default
  labels:
    app.kubernetes.io/name: unleash-connection-test
    app.kubernetes.io/part-of: unleasherator
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: connection-test
    image: curlimages/curl:7.88.1
    command:
    - sh
    - -c
    - |
      echo "Testing connection to Unleash server..."
      curl -s --retry 100 --retry-delay 5 --retry-connrefused http://unleash-connection-test:4242/api/admin/health -o /dev/null -w "HTTP Status: %{http_code}\n"
      if [ $? -eq 0 ]; then
        echo "Connection successful!"
        exit 0
      else
        echo "Connection failed!"
        exit 1
      fi
  restartPolicy: Never
